<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Cliente - Alissa Casagrande</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/exercise-tracker.css">
    <style>
        /* ====== MODERN WHITE/MAGENTA REDESIGN ====== */
        * { box-sizing: border-box; }
        
        body {
            background: #f8f8f8;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            color: #1a1a2e;
        }

        /* ---- LOGIN SCREEN ---- */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff !important;
            padding: 20px;
        }
        
        .login-card {
            background: #fff;
            border-radius: 28px;
            padding: 48px 40px;
            max-width: 420px;
            width: 100%;
            text-align: center;
            box-shadow: 0 8px 48px rgba(255,20,147,0.12), 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #ffe0f0;
        }

        .login-logo img {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #FF1493;
            box-shadow: 0 4px 20px rgba(255,20,147,0.3);
            margin-bottom: 8px;
        }
        
        .login-title {
            font-size: 22px;
            font-weight: 800;
            color: #FF1493;
            letter-spacing: 1px;
            margin: 16px 0 4px;
            text-transform: uppercase;
        }
        
        .login-subtitle {
            font-size: 13px;
            color: #888;
            margin-bottom: 28px;
            line-height: 1.5;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #333;
            font-size: 13px;
            margin-bottom: 8px;
            text-align: left;
        }
        
        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #eee;
            border-radius: 14px;
            font-size: 15px;
            outline: none;
            transition: border 0.2s;
            background: #fafafa;
        }
        
        .form-control:focus {
            border-color: #FF1493;
            background: #fff;
        }
        
        .btn-login {
            width: 100%;
            padding: 16px;
            background: #FF1493 !important;
            color: white !important;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 20px rgba(255,20,147,0.35);
            transition: all 0.2s;
        }
        
        .btn-login:hover {
            background: #e0006e !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(255,20,147,0.45);
        }
        
        .login-footer {
            margin-top: 24px;
            font-size: 12px;
            color: #999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        
        .login-footer button {
            border-radius: 10px !important;
            font-size: 12px !important;
            padding: 8px 16px !important;
        }

        /* ---- HEADER ---- */
        .header {
            background: #fff !important;
            border-bottom: 3px solid #FF1493;
            padding: 0 20px;
            box-shadow: 0 2px 16px rgba(255,20,147,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
        }
        
        .header-content h1 {
            font-size: 16px;
            font-weight: 800;
            color: #FF1493;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .header-content p {
            font-size: 11px;
            color: #666;
            margin: 0;
        }

        /* ---- WELCOME SECTION ---- */
        .welcome-section {
            background: linear-gradient(135deg, #FF1493 0%, #ff6ec7 100%);
            color: white;
            padding: 28px 24px;
            border-radius: 20px;
            margin-bottom: 24px;
            text-align: center;
            box-shadow: 0 6px 24px rgba(255,20,147,0.3);
        }
        
        .welcome-title {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 6px;
        }
        
        .welcome-subtitle {
            font-size: 14px;
            opacity: 0.92;
            font-weight: 500;
        }

        /* ---- CARDS ---- */
        .card {
            background: #fff;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            border: 1px solid #f0f0f0;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #fff0f8;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a2e;
            margin: 0;
        }

        /* ---- PHASE SECTIONS ---- */
        .phase-block {
            background: #fff5fb;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid #FF1493;
        }
        
        .phase-title {
            font-size: 16px;
            font-weight: 700;
            color: #FF1493;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ---- EXERCISE ITEMS with GIF ---- */
        .exercise-item {
            background: #fff;
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 10px;
            border: 1px solid #f0f0f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .exercise-item:last-child {
            margin-bottom: 0;
        }
        
        .exercise-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }
        
        .exercise-name {
            font-weight: 700;
            color: #1a1a2e;
            font-size: 15px;
        }
        
        .exercise-details {
            font-size: 13px;
            color: #888;
            margin-top: 4px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .exercise-details span {
            background: #fff0f8;
            color: #FF1493;
            padding: 2px 8px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
        }

        /* ---- GIF CONTAINER ---- */
        .exercise-gif-container {
            width: 100%;
            max-height: 220px;
            border-radius: 12px;
            overflow: hidden;
            background: #fafafa;
            border: 2px solid #ffe0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .exercise-gif-container img {
            width: 100%;
            height: 220px;
            object-fit: contain;
            border-radius: 10px;
        }
        
        .exercise-gif-placeholder {
            width: 100%;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fff5fb;
            border-radius: 12px;
            color: #FF1493;
            font-size: 13px;
            font-weight: 600;
            gap: 6px;
            border: 2px dashed #ffb3d9;
        }

        /* ---- BUTTONS ---- */
        .btn {
            padding: 12px 20px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-fucsia, .btn-fucsia:visited {
            background: #FF1493 !important;
            color: white !important;
            box-shadow: 0 4px 14px rgba(255,20,147,0.3);
        }
        
        .btn-fucsia:hover {
            background: #e0006e !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,20,147,0.4);
        }
        
        .btn-large {
            padding: 16px 28px;
            font-size: 16px;
        }
        
        .btn-header {
            background: #fff0f8;
            color: #FF1493;
            border: 2px solid #FF1493;
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
        }
        
        .btn-header:hover {
            background: #FF1493;
            color: white;
        }
        
        .btn-logout {
            background: #fff0f0;
            color: #dc2626;
            border: 2px solid #dc2626;
        }
        
        .btn-logout:hover {
            background: #dc2626;
            color: white;
        }

        /* ---- VIDEO BUTTON ---- */
        .btn-video {
            background: #FF1493;
            color: white;
            padding: 8px 14px;
            font-size: 12px;
            border-radius: 10px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* ---- START BUTTON ---- */
        .btn-start-container {
            text-align: center;
            margin: 40px 0;
        }
        
        .btn-start {
            background: linear-gradient(135deg, #FF1493, #ff6ec7);
            font-size: 22px;
            padding: 22px 60px;
            box-shadow: 0 8px 28px rgba(255,20,147,0.4);
            animation: pulse-button 2s infinite;
            border: none;
            border-radius: 18px;
            color: white;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 400px;
            letter-spacing: 0.5px;
        }
        
        @keyframes pulse-button {
            0%, 100% { transform: scale(1); box-shadow: 0 8px 28px rgba(255,20,147,0.4); }
            50% { transform: scale(1.03); box-shadow: 0 12px 36px rgba(255,20,147,0.55); }
        }

        /* ---- TIMER ---- */
        .timer-display {
            background: linear-gradient(135deg, #1a1a2e 0%, #FF1493 100%);
            color: white;
            padding: 36px 20px;
            border-radius: 24px;
            text-align: center;
            margin: 24px auto;
            font-size: 68px;
            font-weight: 800;
            font-family: 'Courier New', monospace;
            box-shadow: 0 12px 36px rgba(255,20,147,0.35);
            max-width: 100%;
            letter-spacing: 4px;
        }
        
        .timer-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 600px) {
            .timer-display { font-size: 48px; padding: 28px 15px; }
            .btn-start { font-size: 18px; padding: 18px 40px; }
            .card { padding: 18px 16px; }
            .login-card { padding: 36px 24px; }
        }

        /* ---- BADGES ---- */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-fucsia {
            background: #fff0f8;
            color: #FF1493;
            border: 1px solid #ffb3d9;
        }
        
        .badge-success {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        /* ---- WORKOUT CARD ---- */
        .workout-card-main {
            background: white;
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        }
        
        .workout-title {
            font-size: 22px;
            font-weight: 800;
            color: #1a1a2e;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 16px;
            border-bottom: 3px solid #FF1493;
        }

        /* ---- MOTIVATIONAL POPUP ---- */
        .motivational-popup {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.65);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        
        .motivational-popup.active { display: flex; }
        
        .motivational-content {
            background: linear-gradient(135deg, #FF1493 0%, #ff6ec7 100%);
            color: white;
            padding: 56px 40px;
            border-radius: 28px;
            text-align: center;
            max-width: 480px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: bounceIn 0.5s ease-out;
        }
        
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.5); }
            70% { transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .motivational-icon { font-size: 72px; margin-bottom: 16px; }
        .motivational-text { font-size: 28px; font-weight: 800; margin-bottom: 10px; }
        .motivational-subtext { font-size: 16px; opacity: 0.9; }

        /* ---- MODAL ---- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 32px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding-bottom: 16px;
            border-bottom: 2px solid #fff0f8;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 800;
            color: #FF1493;
            margin: 0;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        /* ---- FEEDBACK FORM ---- */
        .feedback-form select, .feedback-form textarea, .feedback-form input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #eee;
            border-radius: 12px;
            font-size: 14px;
            outline: none;
            transition: border 0.2s;
        }
        
        .feedback-form select:focus,
        .feedback-form textarea:focus,
        .feedback-form input:focus {
            border-color: #FF1493;
        }

        /* ---- BACKUP FOOTER ---- */
        .backup-footer {
            background: #fff;
            border-top: 2px solid #fff0f8;
            padding: 28px 24px;
            text-align: center;
        }
        
        .backup-footer h3 {
            color: #FF1493;
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        .backup-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn-info { background: #0ea5e9 !important; color: white !important; }
        .btn-success { background: #16a34a !important; color: white !important; }
        .btn-primary { background: #6366f1 !important; color: white !important; }

        /* ---- LOGIN ERROR ---- */
        #loginError {
            background: #fff0f8 !important;
            color: #FF1493 !important;
            border: 1px solid #ffb3d9;
            border-radius: 12px;
            padding: 12px 16px !important;
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        /* ---- EXERCISE NAME CONTAINER ---- */
        .exercise-name-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }
        
        /* ---- PROGRESS/STATS ---- */
        .stat-card {
            background: #fff5fb;
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            border: 1px solid #ffe0f0;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: #FF1493;
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
            font-weight: 500;
        }
    </style>
    <!-- Firebase SDK -->
        <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-logo"><img src="images/logo-alissa.png" alt="Alissa Casagrande" style="width: 120px; height: 120px; border-radius: 50%;"></div>
            <h1 class="login-title">BODY & MIND REVOLUTION</h1>
            <p class="login-subtitle">Alissa Casagrande - Personal Trainer<br>Transform Your Body & Mind</p>
            
            <div class="login-error" id="loginError" style="display: none; background: rgba(239, 68, 68, 0.1); color: #dc2626; padding: 12px; border-radius: 10px; margin-bottom: 20px; font-size: 14px;">
                ‚ùå Nome e cognome non trovati nel sistema.<br>
                <small style="font-size: 12px; opacity: 0.8;">Prova: "Maria Bianchi", "Luca Rossi" o "Sara Verde"</small>
            </div>
            
            <form class="login-form" onsubmit="loginClient(event)">
                <div class="form-group">
                    <label class="form-label">Il Tuo Nome e Cognome</label>
                    <input type="text" class="form-control" id="clientFullName" placeholder="Es: Maria Bianchi" required autocomplete="off">
                </div>
                <button type="submit" class="btn btn-fucsia btn-login">
                    üîì ACCEDI ALLA TUA AREA
                </button>
            </form>

            <div class="login-footer">
                Inserisci il tuo nome e cognome come comunicato dal trainer
                <br><br>
                <button type="button" onclick="document.getElementById('importClientDataFile').click()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 13px; cursor: pointer; margin-top: 10px; font-weight: 600;">
                    üì• Importa Dati dal Trainer (JSON)
                </button>
                <input type="file" id="importClientDataFile" accept=".json" style="display: none;" onchange="importClientData(event)">
                <br>
                <button type="button" onclick="document.getElementById('importCSVFile').click()" style="background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 13px; cursor: pointer; margin-top: 10px; font-weight: 600;">
                    üìä Importa Scheda CSV
                </button>
                <input type="file" id="importCSVFile" accept=".csv" style="display: none;" onchange="importCSVData(event)">
                <br>
                <button type="button" onclick="resetDatabase()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-top: 10px;">
                    üîÑ Reset Database (se problemi login)
                </button>
            </div>
        </div>
    </div>

    <!-- Motivational Popup -->
    <div class="motivational-popup" id="motivationalPopup">
        <div class="motivational-content">
            <div class="motivational-icon">üéµ</div>
            <div class="motivational-text">Accendi la musica e partiamo!</div>
            <div class="motivational-subtext">Preparati a dare il massimo! üí™</div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <!-- Header Compatto -->
        <header class="header">
            <div class="header-content">
                <span class="logo"><img src="images/logo-alissa.png" alt="Logo" style="width: 40px; height: 40px; border-radius: 50%;"></span>
                <div class="header-title">
                    <h1>ALISSA CASAGRANDE</h1>
                    <p>Personal Trainer - Mental Coach | Body & Mind Revolution</p>
                </div>
            </div>

            <div class="header-actions">
                <button class="btn-header btn-logout" onclick="logoutClient()">üö™ Esci</button>
            </div>
        </header>

        <!-- Main Container -->
        <div style="max-width: 1200px; margin: 0 auto; padding: 30px 20px; width: 100%; box-sizing: border-box; overflow-x: hidden;">
            <!-- Welcome Section -->
            <div class="welcome-section">
                <div class="welcome-title">Ciao! üëã</div>
                <div class="welcome-subtitle">Sei pronta per la tua Rivoluzione Body & Mind oggi?</div>
            </div>

            <!-- Content -->
            <div id="mainContent"></div>
        </div>

        <!-- Backup Footer -->
        <div class="backup-footer" style="background: linear-gradient(135deg, rgba(139, 127, 232, 0.05) 0%, rgba(171, 160, 243, 0.05) 100%);">
            <h3>üíæ Gestione Dati Personali</h3>
            <div class="backup-actions">
                <button class="btn btn-fucsia" onclick="importWorkout()">üì• Importa Scheda JSON</button>
                <button class="btn btn-info" onclick="document.getElementById('importCSVFileLogged').click()" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%) !important;">üìä Importa Scheda CSV</button>
                <button class="btn btn-success" onclick="exportClientData()">üíæ Esporta i Miei Dati</button>
                <button class="btn btn-primary" onclick="importClientData()">üì• Importa Dati Completi</button>
                <input type="file" id="workoutFileInput" accept=".json" style="display: none;" onchange="handleWorkoutImport(event)">
                <input type="file" id="dataFileInput" accept=".json" style="display: none;" onchange="handleDataImport(event)">
                <input type="file" id="importCSVFileLogged" accept=".csv" style="display: none;" onchange="importCSVDataLogged(event)">
            </div>
            <p style="margin-top: 15px; font-size: 13px; color: #6b7280;">
                üí° <strong>Consiglio:</strong> Esporta i tuoi dati prima di cambiare telefono per non perdere lo storico
            </p>
        </div>
    </div>

    <!-- Modal Feedback -->
    <div class="modal" id="feedbackModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">üìù Feedback Allenamento</h2>
            </div>

            <form id="feedbackForm" class="feedback-form" style="background: var(--bg-light); padding: 25px; border-radius: 15px;">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="display: block; font-weight: 600; margin-bottom: 8px;">1. Come ti sei sentita durante l'allenamento?</label>
                    <select class="form-control" name="feeling" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px;">
                        <option value="">Seleziona...</option>
                        <option value="ottimo">Ottimo, mi sono sentita benissimo</option>
                        <option value="bene">Bene, faticoso ma positivo</option>
                        <option value="faticoso">Molto faticoso</option>
                        <option value="troppo_facile">Troppo facile, vorrei pi√π sfida</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">2. Quale parte √® stata pi√π difficile?</label>
                    <input type="text" class="form-control" name="difficult_part" placeholder="Es: Plank, Squat, Circuito finale...">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">3. La durata dell'allenamento √® stata:</label>
                    <select class="form-control" name="duration_adjustment">
                        <option value="perfetta">Perfetta</option>
                        <option value="troppo_lunga">Troppo lunga</option>
                        <option value="troppo_corta">Troppo corta</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">4. L'intensit√† degli esercizi √® stata:</label>
                    <select class="form-control" name="intensity_adjustment">
                        <option value="giusta">Giusta</option>
                        <option value="troppo_difficile">Troppo difficile</option>
                        <option value="troppo_facile">Troppo facile</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">5. Hai provato dolore o fastidio durante l'allenamento?</label>
                    <input type="text" class="form-control" name="pain_discomfort" placeholder="Descrivi dove e quando (lascia vuoto se nessun dolore)">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">6. Quali esercizi ti sono piaciuti di pi√π?</label>
                    <input type="text" class="form-control" name="favorite_exercises" placeholder="Es: Ponte glutei, Cat-Cow...">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">7. Note aggiuntive per Alissa:</label>
                    <textarea class="form-control" name="notes" placeholder="Qualsiasi altra cosa vuoi condividere..." style="resize: vertical; min-height: 80px;"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn btn-fucsia btn-large">üí¨ INVIA FEEDBACK</button>
                    <button type="button" class="btn" onclick="closeModal('feedbackModal')">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/database.js"></script>
    <script src="js/backup-manager.js"></script>
    <script src="js/exercise-image-manager.js"></script>
    <script src="js/exercise-youtube-manager.js"></script>

    <script>
        let CLIENT_ID = null;
        let CLIENT_NAME = null;
        let timerInterval = null;
        let timerSeconds = 0;
        let timerRunning = false;
        let currentSession = null;
        
        // Exercise Tracking Variables
        let currentWorkoutPlan = null;
        let allExercises = [];
        let currentExerciseIndex = 0;

        window.addEventListener('DOMContentLoaded', function() {
            // Verifica se c'√® import automatico da URL (QR code)
            const urlParams = new URLSearchParams(window.location.search);
            const importData = urlParams.get('import');
            
            if (importData) {
                console.log('Import automatico da QR code...');
                console.log('üîç Import data raw:', importData.substring(0, 100) + '...');
                
                try {
                    // Decodifica base64
                    const jsonString = decodeURIComponent(escape(atob(importData)));
                    const data = JSON.parse(jsonString);
                    
                    console.log('üì¶ Dati decodificati:', data);
                    
                    // Importa i dati
                    importClientDataFromObject(data);
                    
                    // Rimuovi parametro URL e ricarica
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Alert con nome cliente (supporta entrambi i formati)
                    let clientName = '';
                    if (data.client && data.client.name) {
                        clientName = data.client.name;
                    } else if (data.c && data.c.n) {
                        clientName = data.c.n;
                    } else {
                        clientName = 'Cliente';
                    }
                    
                    alert('‚úÖ Dati importati con successo!\n\nüë§ Cliente: ' + clientName + '\n\nPuoi ora accedere con il tuo nome e cognome.');
                    
                } catch (error) {
                    console.error('‚ùå Errore import automatico:', error);
                    console.error('Stack:', error.stack);
                    alert('‚ùå Errore durante l\'importazione automatica dei dati.\n\nErrore: ' + error.message);
                }
            }
            
            const savedClientId = sessionStorage.getItem('client_id');
            const savedClientName = sessionStorage.getItem('client_name');
            if (savedClientId && savedClientName) {
                CLIENT_ID = savedClientId;
                CLIENT_NAME = savedClientName;
                if (db._ready) {
                    showMainApp();
                } else {
                    document.addEventListener('db_ready', showMainApp, { once: true });
                }
            }
        });


        // ===== GIF MANAGER (CLIENT SIDE - READ ONLY) =====
        const exerciseGifManager = {
            _gifs: {},
            
            init() {
                // Load from localStorage first (fallback)
                const saved = localStorage.getItem('exerciseGifs');
                if (saved) {
                    try { this._gifs = JSON.parse(saved); } catch(e) {}
                }
                // Then load from Firebase
                if (typeof firebaseDB !== 'undefined') {
                    firebaseDB.ref('ptflow/exercise_gifs').on('value', (snap) => {
                        if (snap.exists()) {
                            const data = snap.val();
                            // Convert firebase keys back to exercise names
                            Object.keys(data).forEach(key => {
                                const name = key.replace(/_/g, ' ');
                                this._gifs[name] = data[key];
                                // Also store with original key
                                this._gifs[key] = data[key];
                            });
                        }
                    });
                }
            },
            
            getGif(exerciseName) {
                const key = exerciseName.toLowerCase().trim();
                const fbKey = key.replace(/[^a-z0-9]/g, '_');
                return this._gifs[key] || this._gifs[fbKey] || null;
            },
            
            hasGif(exerciseName) {
                return !!this.getGif(exerciseName);
            }
        };
        
        exerciseGifManager.init();

        function loginClient(event) {
            event.preventDefault();
            const fullName = document.getElementById('clientFullName').value;
            
            if (db._ready) {
                _doLogin(fullName);
            } else {
                // Mostra attesa
                const errorEl = document.getElementById('loginError');
                errorEl.textContent = '‚è≥ Connessione in corso...';
                errorEl.style.color = '#10b981';
                errorEl.style.display = 'block';
                document.addEventListener('db_ready', function() {
                    errorEl.style.display = 'none';
                    _doLogin(fullName);
                }, { once: true });
            }
        }
        
        function _doLogin(fullName) {
            console.log('Tentativo login con:', fullName);
            console.log('Clienti disponibili:', db.getAllClients().map(c => c.name));
            const client = db.authenticateClient(fullName);
            console.log('Cliente trovato:', client);
            
            if (client) {
                CLIENT_ID = client.id;
                CLIENT_NAME = client.name;
                sessionStorage.setItem('client_id', CLIENT_ID);
                sessionStorage.setItem('client_name', CLIENT_NAME);
                showMainApp();
            } else {
                const errorEl = document.getElementById('loginError');
                errorEl.textContent = '‚ùå Nome non trovato. Controlla nome e cognome.';
                errorEl.style.color = '';
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 4000);
            }
        }
        
        // ===== IMPORT DATI CLIENTE =====
        async function importClientDataFromObject(data) {
            // Gestisci formato ULTRA-LIGHT V2 (QR SOLO ID)
            if (data.t === 'l' && data.v === '1') {
                console.log('üì• Import QR ULTRA-MINIMALE V2 rilevato (solo ID)');
                
                // Se c'√® solo plan.id, genera profilo e plan generico
                let plans = [];
                if (data.p && data.p.i) {
                    console.log('üìã Plan ID ricevuto:', data.p.i, '- Creazione scheda generica');
                    plans = [{
                        id: data.p.i,
                        client_id: data.c.i,
                        title: 'Scheda Allenamento',
                        status: 'attiva',
                        duration: '45 minuti',
                        objective: 'Allenamento',
                        phases: {
                            warmup: [],
                            mobility: [],
                            strength: [],
                            circuit: [],
                            cooldown: []
                        },
                        created_at: Date.now(),
                        sent_at: Date.now()
                    }];
                    console.log('‚ö†Ô∏è NOTA: Scheda vuota creata. Il trainer deve inviare JSON completo per i dati reali.');
                }
                
                // Converti formato ultra-light in formato standard
                data = {
                    version: '1.0',
                    export_type: 'single_client',
                    client: {
                        id: data.c.i,
                        name: data.c.n,
                        email: '',
                        created_at: Date.now(),
                        is_active: true
                    },
                    profile: {
                        client_id: data.c.i,
                        age: 30,
                        weight: 60,
                        goal: 'Generale',
                        level: 'Intermedio',
                        frequency: 3,
                        problems: [],
                        equipment: [],
                        custom_problems: ''
                    },
                    plans: plans,
                    sessions: [],
                    feedback: []
                };
                
                console.log('‚úÖ Formato ultra-minimale convertito:', data.client.name);
            }
            // Gestisci formato LIGHT (QR ultra-leggero)
            else if (data.t === 'light' && data.v === '1.0') {
                console.log('üì• Import QR Ultra-Leggero rilevato');
                
                // Converti formato light in formato standard
                data = {
                    version: data.v,
                    export_type: 'single_client',
                    client: {
                        id: data.c.id,
                        name: data.c.name,
                        email: data.c.email,
                        created_at: Date.now(),
                        is_active: true
                    },
                    profile: {
                        client_id: data.c.id,
                        age: data.p.age,
                        weight: data.p.weight,
                        goal: data.p.goal,
                        level: data.p.level,
                        frequency: data.p.frequency,
                        problems: data.p.problems,
                        equipment: data.p.equipment,
                        custom_problems: ''
                    },
                    plans: data.plan ? [{
                        id: data.plan.id,
                        client_id: data.c.id,
                        title: data.plan.title,
                        status: data.plan.status,
                        duration: data.plan.duration,
                        objective: data.plan.objective,
                        phases: data.plan.phases,
                        created_at: data.plan.created_at || Date.now(),
                        sent_at: Date.now()
                    }] : [],
                    sessions: [],
                    feedback: []
                };
                
                console.log('‚úÖ Formato convertito:', data.client.name);
            }
            
            // Verifica che sia un export cliente valido
            if (!data.export_type || data.export_type !== 'single_client') {
                throw new Error('File non valido');
            }
            
            if (!data.client || !data.profile) {
                throw new Error('File incompleto');
            }
            
            // Importa i dati su Firebase
            const clients = db.getAllClients();
            const profiles = db._cache ? (_cache.profiles||[]) : [];
            const plans = db.getAllPlans();
            const sessions = db.getAllSessions();
            const feedback = db.getAllFeedback();
            
            // Verifica se il cliente esiste gi√†
            const existingClientIndex = clients.findIndex(function(c) { return c.id === data.client.id; });
            const existingProfileIndex = profiles.findIndex(function(p) { return p.client_id === data.client.id; });
            
            if (existingClientIndex !== -1) {
                await db.updateClient(data.client.id, data.client);
                await db.updateProfile(data.client.id, data.profile);
                const newPlans = plans.filter(function(p) { return p.client_id !== data.client.id; }).concat(data.plans || []);
                const newSessions = sessions.filter(function(s) { return s.client_id !== data.client.id; }).concat(data.sessions || []);
                const newFeedback = feedback.filter(function(f) { return f.client_id !== data.client.id; }).concat(data.feedback || []);
                await saveCollection('plans', newPlans);
                await saveCollection('sessions', newSessions);
                await saveCollection('feedback', newFeedback);
            } else {
                await db.addClient(data.client);
                await db.updateProfile(data.client.id, data.profile);
                if (data.plans) for(const p of data.plans) await db.addPlan(p);
                if (data.sessions) for(const s of data.sessions) await db.addSession(s);
                if (data.feedback) for(const f of data.feedback) await db.addFeedback(f);
            }
        }
        
        async function importClientData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Usa la funzione helper
                    importClientDataFromObject(data);
                    
                    alert('‚úÖ Dati importati con successo!\n\nüë§ Cliente: ' + data.client.name + '\n\nPuoi ora accedere con il tuo nome e cognome.');
                    
                    // Reset del form
                    event.target.value = '';
                    
                } catch (error) {
                    console.error('Errore import:', error);
                    if (error.message === 'File non valido') {
                        alert('‚ùå File non valido!\n\nQuesto non √® un file di esportazione cliente.');
                    } else if (error.message === 'File incompleto') {
                        alert('‚ùå File incompleto!\n\nIl file non contiene tutti i dati necessari.');
                    } else {
                        alert('‚ùå Errore durante l\'importazione!\n\nIl file potrebbe essere corrotto.');
                    }
                }
            };
            reader.readAsText(file);
        }
        
        async function importCSVData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('‚ùå File CSV vuoto o non valido!');
                        return;
                    }
                    
                    console.log('üìä Import CSV:', lines.length, 'righe');
                    
                    // Parse CSV (skip header)
                    const exercises = {
                        warmup: [],
                        mobility: [],
                        strength: [],
                        circuit: [],
                        cooldown: []
                    };
                    
                    const phaseMap = {
                        'Riscaldamento': 'warmup',
                        'Mobilit√†': 'mobility',
                        'Rinforzo': 'strength',
                        'Circuito': 'circuit',
                        'Defaticamento': 'cooldown'
                    };
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // Parse CSV line (handle quoted values)
                        const matches = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                        if (!matches || matches.length < 3) continue;
                        
                        const phase = matches[0].replace(/"/g, '').trim();
                        const name = matches[1].replace(/"/g, '').trim();
                        const reps = matches[2].replace(/"/g, '').trim();
                        
                        // Fix: usa includes() per gestire emoji e testo extra nel campo fase
                        let phaseKey = null;
                        for (const [keyword, key] of Object.entries(phaseMap)) {
                            if (phase.includes(keyword)) {
                                phaseKey = key;
                                break;
                            }
                        }
                        if (phaseKey && name) {
                            exercises[phaseKey].push({
                                name: name,
                                reps: reps || '',
                                duration: reps || ''
                            });
                        }
                    }
                    
                    console.log('‚úÖ Esercizi parsati:', exercises);
                    
                    // Chiedi nome cliente
                    const clientName = prompt('üìù Inserisci il nome del cliente per questa scheda:');
                    if (!clientName) {
                        alert('‚ùå Import annullato - nome richiesto!');
                        return;
                    }
                    
                    // Crea cliente e scheda
                    const clientId = 'csv-' + Date.now();
                    const planId = 'plan-csv-' + Date.now();
                    
                    const newClient = {
                        id: clientId,
                        name: clientName,
                        email: '',
                        created_at: Date.now(),
                        is_active: true
                    };
                    
                    const newProfile = {
                        client_id: clientId,
                        age: 30,
                        weight: 60,
                        goal: 'Generale',
                        level: 'Intermedio',
                        frequency: 3,
                        problems: [],
                        equipment: [],
                        custom_problems: ''
                    };
                    
                    const newPlan = {
                        id: planId,
                        client_id: clientId,
                        title: 'Scheda da CSV',
                        status: 'attiva',
                        duration: '45 minuti',
                        objective: 'Allenamento',
                        phases: exercises,
                        created_at: Date.now(),
                        sent_at: Date.now()
                    };
                    
                    // Salva su Firebase tramite db
                    await db.addClient(newClient);
                    await db.updateProfile(newClient.id, newProfile);
                    await db.addPlan(newPlan);
                    
                    console.log('‚úÖ Dati CSV salvati su Firebase per cliente:', clientName);
                    
                    alert('‚úÖ Scheda CSV importata con successo!\n\nüë§ Cliente: ' + clientName + '\n\nAccesso automatico in corso...');
                    
                    // Reset del form
                    event.target.value = '';
                    
                    // AUTO-LOGIN dopo import CSV
                    CLIENT_ID = clientId;
                    CLIENT_NAME = clientName;
                    sessionStorage.setItem('client_id', clientId);
                    sessionStorage.setItem('client_name', clientName);
                    
                    // Nascondi login, mostra app
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    // Carica dashboard
                    loadClientData();
                    
                } catch (error) {
                    console.error('‚ùå Errore import CSV:', error);
                    alert('‚ùå Errore durante import CSV:\n\n' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        async function importCSVDataLogged(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Usa CLIENT_ID esistente
            if (!CLIENT_ID) {
                alert('‚ùå Errore: Non sei loggato!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('‚ùå File CSV vuoto o non valido!');
                        return;
                    }
                    
                    console.log('üìä Import CSV (loggato):', lines.length, 'righe');
                    
                    // Parse CSV (skip header)
                    const exercises = {
                        warmup: [],
                        mobility: [],
                        strength: [],
                        circuit: [],
                        cooldown: []
                    };
                    
                    const phaseMap = {
                        'Riscaldamento': 'warmup',
                        'Mobilit√†': 'mobility',
                        'Rinforzo': 'strength',
                        'Circuito': 'circuit',
                        'Defaticamento': 'cooldown'
                    };
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // Parse CSV line (handle quoted values)
                        const matches = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                        if (!matches || matches.length < 3) continue;
                        
                        const phase = matches[0].replace(/"/g, '').trim();
                        const name = matches[1].replace(/"/g, '').trim();
                        const reps = matches[2].replace(/"/g, '').trim();
                        
                        // Fix: usa includes() per gestire emoji e testo extra nel campo fase
                        let phaseKey = null;
                        for (const [keyword, key] of Object.entries(phaseMap)) {
                            if (phase.includes(keyword)) {
                                phaseKey = key;
                                break;
                            }
                        }
                        if (phaseKey && name) {
                            exercises[phaseKey].push({
                                name: name,
                                reps: reps || '',
                                duration: reps || ''
                            });
                        }
                    }
                    
                    console.log('‚úÖ Esercizi parsati:', exercises);
                    
                    // Crea nuova scheda per cliente esistente
                    const planId = 'plan-csv-' + Date.now();
                    
                    const newPlan = {
                        id: planId,
                        client_id: CLIENT_ID,
                        title: 'Scheda da CSV',
                        status: 'attiva',
                        duration: '45 minuti',
                        objective: 'Allenamento',
                        phases: exercises,
                        created_at: Date.now(),
                        sent_at: Date.now()
                    };
                    
                    // Prima disattiva tutte le altre schede attive
                    const plans = db.getAllPlans();
                    for (const p of plans) {
                        if (p.client_id === CLIENT_ID && p.status === 'attiva') {
                            await db.updatePlan(p.id, {status: 'inattiva'});
                        }
                    }
                    
                    // Aggiungi nuova scheda su Firebase
                    await db.addPlan(newPlan);
                    
                    console.log('‚úÖ Scheda CSV salvata per cliente:', CLIENT_NAME);
                    console.log('üìã ID Scheda:', newPlan.id);
                    console.log('üìã Client ID:', newPlan.client_id);
                    console.log('üìã Status:', newPlan.status);
                    console.log('üìã Tutte le schede dopo save:', db.getAllPlans());
                    
                    alert('‚úÖ Scheda CSV importata con successo!\n\nüìã Scheda: "Scheda da CSV"\n\nRicarica la pagina per visualizzarla.');
                    
                    // Reset del form
                    event.target.value = '';
                    
                    // Ricarica dashboard
                    setTimeout(function() {
                        location.reload();
                    }, 2000);
                    
                } catch (error) {
                    console.error('‚ùå Errore import CSV:', error);
                    alert('‚ùå Errore durante import CSV:\n\n' + error.message);
                }
            };
            reader.readAsText(file);
        }

        async function resetDatabase() {
            if (confirm('‚ö†Ô∏è Questo resetter√† tutti i dati demo.\n\nVuoi continuare?')) {
                await firebaseDB.ref('ptflow').remove();
                sessionStorage.clear();
                location.reload();
            }
        }

        function logoutClient() {
            if (confirm('Vuoi davvero uscire dalla tua area?')) {
                sessionStorage.removeItem('client_id');
                sessionStorage.removeItem('client_name');
                CLIENT_ID = null;
                CLIENT_NAME = null;
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('clientFullName').value = '';
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadClientData();
        }

        function loadClientData() {
            console.log('=== LOAD CLIENT DATA ===');
            console.log('Client ID:', CLIENT_ID);
            console.log('üìã Tutte le schede nel DB:', db.getAllPlans());
            console.log('üìã Schede per questo cliente:', db.getPlansByClientId(CLIENT_ID));
            
            const activePlan = db.getActivePlanByClientId(CLIENT_ID);
            console.log('Scheda attiva trovata:', activePlan);
            
            const sessions = db.getSessionsByClientId(CLIENT_ID);
            console.log('Sessioni trovate:', sessions.length);

            let html = activePlan ? renderActiveWorkout(activePlan) : renderNoWorkout();
            html += renderHistory(sessions);
            html += `
                <div class="info-box" style="background: rgba(0, 206, 209, 0.1); border-left: 4px solid var(--cyan); padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <strong>üí° Ricorda:</strong><br>
                    Dopo ogni allenamento, compila il feedback per aiutare Alissa a creare schede sempre pi√π personalizzate per te!
                </div>
            `;

            document.getElementById('mainContent').innerHTML = html;
            console.log('========================');
        }

        function renderActiveWorkout(plan) {
            return `
                <div class="workout-card-main">
                    <h2 class="workout-title">La Tua Scheda Personalizzata</h2>

                    <div style="text-align: center; margin-bottom: 30px;">
                        <h3 style="color: var(--navy); font-size: 22px; margin-bottom: 15px;">${plan.title}</h3>
                        <span class="badge badge-cyan" style="font-size: 15px; padding: 10px 18px;">‚è±Ô∏è ${plan.duration} min</span>
                        <span class="badge badge-arancio" style="font-size: 15px; padding: 10px 18px;">üìÖ ${new Date(plan.approved_at || plan.generated_at).toLocaleDateString('it-IT')}</span>
                    </div>

                    ${renderWorkoutPhases(plan)}

                    <div class="btn-start-container">
                        <button class="btn btn-fucsia btn-large btn-start" onclick="startWorkout('${plan.id}')">
                            ‚ñ∂Ô∏è INIZIA LA TUA RIVOLUZIONE
                        </button>
                    </div>

                    <!-- Timer Section -->
                    <div id="timerSection" style="display: none; margin-top: 30px;">
                        <!-- Current Exercise Display -->
                        <div id="currentExerciseCard" class="current-exercise-card">
                            <div class="exercise-phase-badge" id="exercisePhaseBadge">üî• RISCALDAMENTO</div>
                            <div class="current-exercise-visual">
                                <img id="exerciseImage" src="" alt="Esercizio" class="exercise-anatomical-image" style="display: none;">
                                <div id="exerciseImagePlaceholder" class="exercise-placeholder">
                                    <span style="font-size: 48px;">üí™</span>
                                </div>
                            </div>
                            <h3 id="currentExerciseName" class="current-exercise-name">Preparati per iniziare!</h3>
                            <div id="currentExerciseDetails" class="current-exercise-details">
                                <span id="exerciseReps"></span>
                                <span id="exerciseDuration"></span>
                            </div>
                            <div class="exercise-progress-info">
                                <span id="exerciseProgressText">Esercizio 1 di 15</span>
                            </div>
                            <!-- Bottone Guarda Esercizio (YouTube/Immagine) -->
                            <div id="exerciseMediaButton" style="display: none; margin-top: 15px;"></div>
                        </div>

                        <!-- GIF Esercizio Attivo (sopra timer) -->
                        <div id="activeExerciseGif" style="display:none; width:100%; max-width:400px; margin: 16px auto 0; border-radius:16px; overflow:hidden; border:3px solid #FF1493; background:#fff5fb;">
                            <img id="activeGifImg" src="" alt="GIF Esercizio" style="width:100%; height:240px; object-fit:contain; display:block;">
                        </div>

                        <!-- Timer Display -->
                        <div class="timer-display" id="timerDisplay">00:00</div>
                        
                        <!-- Timer Controls -->
                        <div class="timer-controls">
                            <button class="btn btn-next-exercise" onclick="nextExercise()" id="btnNextExercise">
                                ‚û°Ô∏è Prossimo Esercizio
                            </button>
                            <button class="btn btn-pause" onclick="pauseTimer()">‚è∏Ô∏è Pausa</button>
                            <button class="btn btn-restart" onclick="restartWorkout()">üîÑ Ricomincia</button>
                            <button class="btn btn-stop" onclick="stopWorkout()">‚èπÔ∏è Completa Allenamento</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWorkoutPhases(plan) {
            let html = '';
            
            const sections = [
                { title: 'üî• Riscaldamento', exercises: plan.phases.warmup, color: 'var(--arancio)' },
                { title: 'üßò Mobilit√†', exercises: plan.phases.mobility, color: 'var(--cyan)' },
                { title: (plan.phases.strength && plan.phases.strength.title) ? plan.phases.strength.title : 'üí™ Rinforzo', exercises: (plan.phases.strength && plan.phases.strength.exercises) ? plan.phases.strength.exercises : plan.phases.strength, color: 'var(--fucsia)' },
                { title: (plan.phases.circuit && plan.phases.circuit.title) ? plan.phases.circuit.title : 'üî• Circuito', exercises: (plan.phases.circuit && plan.phases.circuit.exercises) ? plan.phases.circuit.exercises : plan.phases.circuit, color: 'var(--arancio)' },
                { title: '‚ùÑÔ∏è Defaticamento', exercises: plan.phases.cooldown, color: 'var(--cyan)' }
            ];

            sections.forEach(section => {
                if (section.exercises && section.exercises.length > 0) {
                    html += `
                        <div class="phase-block">
                            <div class="phase-title">${section.title}</div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${section.exercises.map(ex => {
                                    // ‚úÖ PRIORIT√Ä: YouTube > Immagine > Nessun link
                                    const youtubeLink = exerciseYouTubeLinkManager.getLink(ex.name);
                                    const imageLink = exerciseImageManager.getImage(ex.name);
                                    
                                    let mediaButton = '';
                                    if (youtubeLink) {
                                        mediaButton = `<a href="${youtubeLink}" target="_blank" rel="noopener noreferrer" class="btn-video" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; padding: 8px 16px; font-size: 13px; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; font-weight: 600; white-space: nowrap;">‚ñ∂Ô∏è Guarda l'Esercizio</a>`;
                                    } else if (imageLink) {
                                        mediaButton = `<a href="${imageLink}" target="_blank" rel="noopener noreferrer" class="btn-video" style="background: linear-gradient(135deg, #8B7FE8 0%, #7166D9 100%); color: white; padding: 8px 16px; font-size: 13px; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; font-weight: 600; white-space: nowrap;">üñºÔ∏è Guarda l'Esercizio</a>`;
                                    }
                                    
                                    const gifUrl = ex.gif_url || ex.gifUrl || ex.gif || (typeof exerciseGifManager !== 'undefined' ? exerciseGifManager.getGif(ex.name) : null);
                                    const gifHtml = gifUrl ? `
                                        <div class="exercise-gif-container">
                                            <img src="${gifUrl}" alt="${ex.name}" loading="lazy" />
                                        </div>` : '';
                                    
                                    return `
                                        <div class="exercise-item">
                                            <div class="exercise-top">
                                                <div class="exercise-info">
                                                    <div class="exercise-name">${ex.name}</div>
                                                    <div class="exercise-details">
                                                        ${ex.reps ? `<span>üìä ${ex.reps}</span>` : ''}
                                                        ${ex.duration ? `<span>‚è±Ô∏è ${ex.duration}</span>` : ''}
                                                    </div>
                                                </div>
                                                ${mediaButton}
                                            </div>
                                            ${gifHtml}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            return html;
        }

        function renderNoWorkout() {
            return `
                <div class="card" style="text-align: center; padding: 48px 24px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">üì≠</div>
                    <h2 style="color: #1a1a2e; margin-bottom: 15px;">Nessuna Scheda Attiva</h2>
                    <p style="color: #6b7280; font-size: 16px; margin-bottom: 30px;">
                        Ancora nessuna scheda di allenamento. Alissa sta preparando il tuo programma personalizzato!
                    </p>
                    <button class="btn btn-fucsia btn-large" onclick="importWorkout()">
                        üì• IMPORTA SCHEDA RICEVUTA
                    </button>
                </div>
            `;
        }

        function renderHistory(sessions) {
            if (sessions.length === 0) return '';
            return `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìä Storico Allenamenti</h2>
                        <span class="badge badge-fucsia">${sessions.length} completati</span>
                    </div>
                    <ul style="list-style: none; padding: 0;">
                        ${sessions.slice(-5).reverse().map(session => `
                            <li style="padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${new Date(session.completed_at).toLocaleDateString('it-IT')}</strong>
                                    <div style="font-size: 14px; color: #6b7280;">Durata: ${Math.floor(session.duration_actual / 60)} minuti</div>
                                </div>
                                <span style="font-size: 24px;">‚úÖ</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        function startWorkout(planId) {
            // Get the workout plan
            currentWorkoutPlan = db.getActivePlanByClientId(CLIENT_ID);
            if (!currentWorkoutPlan) {
                backupManager.showNotification('‚ùå Errore: scheda non trovata', 'error');
                return;
            }
            
            // Build complete exercise list
            allExercises = [];
            const sections = [
                { title: 'üî• Riscaldamento', exercises: currentWorkoutPlan.phases.warmup, badge: 'üî• RISCALDAMENTO' },
                { title: 'üßò Mobilit√†', exercises: currentWorkoutPlan.phases.mobility, badge: 'üßò MOBILIT√Ä' },
                { title: 'üí™ Rinforzo', exercises: (currentWorkoutPlan.phases.strength && currentWorkoutPlan.phases.strength.exercises) ? currentWorkoutPlan.phases.strength.exercises : currentWorkoutPlan.phases.strength, badge: 'üí™ RINFORZO' },
                { title: 'üî• Circuito', exercises: (currentWorkoutPlan.phases.circuit && currentWorkoutPlan.phases.circuit.exercises) ? currentWorkoutPlan.phases.circuit.exercises : currentWorkoutPlan.phases.circuit, badge: 'üî• CIRCUITO' },
                { title: '‚ùÑÔ∏è Defaticamento', exercises: currentWorkoutPlan.phases.cooldown, badge: '‚ùÑÔ∏è DEFATICAMENTO' }
            ];
            
            sections.forEach(section => {
                if (section.exercises && section.exercises.length > 0) {
                    section.exercises.forEach(ex => {
                        allExercises.push({
                            ...ex,
                            phase: section.title,
                            badge: section.badge
                        });
                    });
                }
            });
            
            currentExerciseIndex = 0;
            
            // Show motivational popup
            document.getElementById('motivationalPopup').classList.add('active');
            
            setTimeout(() => {
                document.getElementById('motivationalPopup').classList.remove('active');
                
                currentSession = {
                    plan_id: planId,
                    client_id: CLIENT_ID,
                    started_at: Date.now()
                };

                document.getElementById('timerSection').style.display = 'block';
                timerRunning = true;
                timerSeconds = 0;
                updateTimerDisplay();
                updateCurrentExerciseDisplay();
                
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                }, 1000);

                backupManager.showNotification('üî• Allenamento iniziato! Dai il massimo!', 'success');
                
                // Scroll to timer
                document.getElementById('timerSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 2500);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            document.getElementById('timerDisplay').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function updateCurrentExerciseDisplay() {
            if (!allExercises || allExercises.length === 0) return;
            
            const exercise = allExercises[currentExerciseIndex];
            if (!exercise) return;
            
            // Update phase badge
            document.getElementById('exercisePhaseBadge').textContent = exercise.badge || 'üí™ ALLENAMENTO';
            
            // Update exercise name
            document.getElementById('currentExerciseName').textContent = exercise.name || 'Esercizio';
            
            // Update reps and duration
            const repsEl = document.getElementById('exerciseReps');
            const durationEl = document.getElementById('exerciseDuration');
            repsEl.textContent = exercise.reps ? `üìä ${exercise.reps}` : '';
            durationEl.textContent = exercise.duration ? `‚è±Ô∏è ${exercise.duration}` : '';
            
            // Update progress
            document.getElementById('exerciseProgressText').textContent = 
                `Esercizio ${currentExerciseIndex + 1} di ${allExercises.length}`;
            
            // ---- GIF sopra il timer ----
            const gifContainer = document.getElementById('activeExerciseGif');
            const gifImg = document.getElementById('activeGifImg');
            const gifUrl = typeof exerciseGifManager !== 'undefined' ? exerciseGifManager.getGif(exercise.name) : null;
            if (gifContainer && gifImg) {
                if (gifUrl) {
                    gifImg.src = gifUrl;
                    gifContainer.style.display = 'block';
                } else {
                    gifContainer.style.display = 'none';
                    gifImg.src = '';
                }
            }

            // Load exercise image from storage
            const imgEl = document.getElementById('exerciseImage');
            const placeholderEl = document.getElementById('exerciseImagePlaceholder');
            const savedImage = exerciseImageManager.getImage(exercise.name);
            const savedYouTube = exerciseYouTubeLinkManager.getLink(exercise.name);
            
            // Priorit√†: YouTube > Immagine > Placeholder
            if (savedYouTube) {
                // Mostra solo emoji nel cerchio
                imgEl.style.display = 'none';
                placeholderEl.style.display = 'flex';
                placeholderEl.innerHTML = `<span style="font-size: 48px;">üé•</span>`;
                
                // Crea bottone YouTube sotto il cerchio
                const btnContainer = document.getElementById('exerciseMediaButton');
                if (btnContainer) {
                    btnContainer.innerHTML = `
                        <a href="${savedYouTube}" target="_blank" rel="noopener noreferrer" 
                           class="btn-watch-exercise">
                            <span class="btn-icon">‚ñ∂Ô∏è</span>
                            <span class="btn-text">Guarda Esercizio</span>
                        </a>
                    `;
                    btnContainer.style.display = 'block';
                }
            } else if (savedImage) {
                // Mostra immagine
                imgEl.src = savedImage;
                imgEl.style.display = 'block';
                imgEl.style.cursor = 'pointer';
                imgEl.onclick = () => {
                    window.open(savedImage, '_blank');
                };
                placeholderEl.style.display = 'none';
                
                // Nascondi bottone
                const btnContainer = document.getElementById('exerciseMediaButton');
                if (btnContainer) btnContainer.style.display = 'none';
            } else {
                // Mostra placeholder default
                imgEl.style.display = 'none';
                placeholderEl.style.display = 'flex';
                placeholderEl.innerHTML = `<span style="font-size: 48px;">üí™</span>`;
                
                // Nascondi bottone
                const btnContainer = document.getElementById('exerciseMediaButton');
                if (btnContainer) btnContainer.style.display = 'none';
            }
            
            // Disable next button on last exercise
            const btnNext = document.getElementById('btnNextExercise');
            if (currentExerciseIndex >= allExercises.length - 1) {
                btnNext.disabled = true;
                btnNext.textContent = '‚úÖ Ultimo Esercizio';
            } else {
                btnNext.disabled = false;
                btnNext.textContent = '‚û°Ô∏è Prossimo Esercizio';
            }
            
            // Animation
            const card = document.getElementById('currentExerciseCard');
            card.style.animation = 'none';
            setTimeout(() => {
                card.style.animation = 'slideIn 0.5s ease';
            }, 10);
        }
        
        function nextExercise() {
            if (currentExerciseIndex < allExercises.length - 1) {
                currentExerciseIndex++;
                updateCurrentExerciseDisplay();
                backupManager.showNotification('‚úÖ Prossimo esercizio!', 'success');
            } else {
                backupManager.showNotification('‚úÖ Hai completato tutti gli esercizi!', 'success');
            }
        }

        function pauseTimer() {
            if (timerRunning) {
                clearInterval(timerInterval);
                timerRunning = false;
                backupManager.showNotification('‚è∏Ô∏è Timer in pausa', 'info');
            } else {
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                }, 1000);
                timerRunning = true;
                backupManager.showNotification('‚ñ∂Ô∏è Timer riavviato', 'success');
            }
        }

        function restartWorkout() {
            if (confirm('üîÑ Vuoi ricominciare l\'allenamento da capo?')) {
                clearInterval(timerInterval);
                timerSeconds = 0;
                timerRunning = true;
                updateTimerDisplay();
                
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                }, 1000);
                
                backupManager.showNotification('üîÑ Allenamento riavviato!', 'success');
            }
        }

        function stopWorkout() {
            if (!currentSession) return;

            clearInterval(timerInterval);
            timerRunning = false;

            currentSession.duration_actual = timerSeconds;
            db.addSession(currentSession);

            document.getElementById('feedbackModal').classList.add('active');
            backupManager.showNotification('‚úÖ Allenamento completato! Ottimo lavoro!', 'success');
        }

        document.getElementById('feedbackForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const feedback = {
                session_id: currentSession ? `session_${currentSession.started_at}` : null,
                client_id: CLIENT_ID,
                feeling: formData.get('feeling'),
                difficult_part: formData.get('difficult_part'),
                duration_adjustment: formData.get('duration_adjustment'),
                intensity_adjustment: formData.get('intensity_adjustment'),
                pain_discomfort: formData.get('pain_discomfort'),
                favorite_exercises: formData.get('favorite_exercises'),
                notes: formData.get('notes')
            };

            db.addFeedback(feedback);

            closeModal('feedbackModal');
            e.target.reset();
            
            backupManager.showNotification('üí¨ Feedback inviato ad Alissa! Grazie!', 'success');
            
            timerSeconds = 0;
            currentSession = null;
            document.getElementById('timerSection').style.display = 'none';
            
            loadClientData();
        });

        async function importWorkout() {
            document.getElementById('workoutFileInput').click();
        }

        async function handleWorkoutImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                console.log('=== IMPORT SCHEDA JSON ===');
                console.log('Dati ricevuti:', data);
                
                // Verifica formato
                if (!data.plan) {
                    backupManager.showNotification('‚ùå File JSON non valido', 'error');
                    return;
                }
                
                // Imposta il plan con status attiva per questo cliente
                const plan = {
                    ...data.plan,
                    client_id: CLIENT_ID,
                    status: 'attiva',
                    imported_at: new Date().toISOString()
                };
                
                // Disattiva eventuali piani attivi esistenti
                const existingPlans = db.getPlansByClientId(CLIENT_ID);
                existingPlans.forEach(p => {
                    if (p.status === 'attiva') {
                        db.updatePlan(p.id, { status: 'completata' });
                    }
                });
                
                // Salva il nuovo plan
                db.addPlan(plan);
                
                console.log('Piano importato:', plan);
                console.log('========================');
                
                backupManager.showNotification('‚úÖ Scheda importata con successo!', 'success');
                
                // Ricarica i dati
                loadClientData();
                
            } catch (error) {
                console.error('Errore import:', error);
                backupManager.showNotification('‚ùå Errore durante l\'import. Verifica il file', 'error');
            }
            
            event.target.value = '';
        }

        async function exportClientData() {
            backupManager.exportClientData(CLIENT_ID);
        }

        function importClientData() {
            document.getElementById('dataFileInput').click();
        }

        async function handleDataImport(event) {
            const file = event.target.files[0];
            if (file) await backupManager.importClientData(file);
            event.target.value = '';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
    </script>
</body>
</html>
