// Sostituisci la funzione downloadSchedaPDF nel file cliente.html con questa:

async function downloadSchedaPDF() {
    const plan = db.getActivePlanByClientId(CLIENT_ID);
    if (!plan) {
        alert('Nessuna scheda disponibile');
        return;
    }

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
        
        let y = 15;
        const margin = 20;
        const pageW = doc.internal.pageSize.width;
        const contentW = pageW - (margin * 2);
        const pageH = doc.internal.pageSize.height;

        // ===== HEADER CON LOGO =====
        const logoSize = 25;
        const logoX = margin;
        const logoY = 8;
        
        // Crea cerchio per il logo (placeholder - usa il tuo logo reale se disponibile)
        doc.setFillColor(255, 20, 147);
        doc.circle(logoX + logoSize/2, logoY + logoSize/2, logoSize/2, 'F');
        doc.setFontSize(12);
        doc.setTextColor(255, 255, 255);
        doc.text('AC', logoX + logoSize/2, logoY + logoSize/2 + 1, { align: 'center', baseline: 'middle' });

        // Testo header
        doc.setTextColor(255, 20, 147);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('ALISSA CASAGRANDE', logoX + logoSize + 8, logoY + 6);
        
        doc.setFontSize(9);
        doc.setTextColor(100, 100, 100);
        doc.setFont('helvetica', 'normal');
        doc.text('Personal Trainer & Mental Coach - Body & Mind Revolution', logoX + logoSize + 8, logoY + 12);

        // Linea decorativa
        doc.setDrawColor(255, 20, 147);
        doc.setLineWidth(1);
        doc.line(margin, logoY + logoSize + 3, pageW - margin, logoY + logoSize + 3);

        y = logoY + logoSize + 12;

        // ===== TITOLO SCHEDA =====
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(255, 20, 147);
        doc.text(plan.title || 'Scheda di Allenamento', pageW / 2, y, { align: 'center' });
        y += 10;

        // ===== INFO SCHEDA =====
        doc.setFillColor(255, 240, 248);
        doc.rect(margin, y - 3, contentW, 10, 'F');
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(255, 20, 147);
        doc.text(`Durata: ${plan.duration} min  |  Obiettivo: ${plan.objective}`, margin + 3, y + 2);
        y += 14;

        // ===== SEZIONI ESERCIZI =====
        const phases = [
            { title: 'ðŸ”¥ RISCALDAMENTO', color: [255, 100, 100], ex: normalizeEx(plan.phases.warmup) },
            { title: 'ðŸ§˜ MOBILIT', color: [100, 150, 255], ex: normalizeEx(plan.phases.mobility) },
            { title: 'ðŸ’ª RINFORZO', color: [255, 20, 147], ex: normalizeEx((plan.phases.strength?.exercises) || plan.phases.strength) },
            { title: 'âš¡ CIRCUITO', color: [255, 165, 0], ex: normalizeEx((plan.phases.circuit?.exercises) || plan.phases.circuit) },
            { title: 'âœ¨ DEFATICAMENTO', color: [100, 200, 100], ex: normalizeEx(plan.phases.cooldown) }
        ];

        phases.forEach(phase => {
            if (phase.ex.length > 0) {
                // Controlla se serve una nuova pagina
                if (y > pageH - 50) {
                    doc.addPage();
                    y = 20;
                }

                // Titolo sezione con sfondo colorato
                doc.setFillColor(...phase.color);
                doc.rect(margin, y - 4, contentW, 8, 'F');
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text(phase.title, margin + 3, y);
                y += 12;

                // Esercizi
                phase.ex.forEach((ex, idx) => {
                    if (y > pageH - 20) {
                        doc.addPage();
                        y = 20;
                    }

                    // Numero e nome esercizio
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(40, 40, 40);
                    doc.text(`${idx + 1}. ${ex.name}`, margin + 3, y);
                    y += 5;

                    // Dettagli
                    if (ex.reps || ex.duration) {
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(100, 100, 100);
                        
                        let details = [];
                        if (ex.reps) details.push(`Ripetizioni: ${ex.reps}`);
                        if (ex.duration) details.push(`Durata: ${ex.duration}`);
                        
                        doc.text(details.join('  |  '), margin + 5, y);
                    }

                    y += 6;
                    
                    // Spazio tra esercizi
                    doc.setDrawColor(230, 230, 230);
                    doc.setLineWidth(0.3);
                    doc.line(margin + 3, y, pageW - margin - 3, y);
                    y += 3;
                });

                // Spazio tra sezioni
                y += 6;
            }
        });

        // ===== FOOTER =====
        const footerY = pageH - 10;
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.setFont('helvetica', 'italic');
        doc.text('Body & Mind Revolution - Alissa Casagrande', pageW / 2, footerY, { align: 'center' });
        doc.text(`Generato: ${new Date().toLocaleDateString('it-IT')}`, pageW / 2, footerY + 4, { align: 'center' });

        const filename = `Scheda_${CLIENT_NAME.replace(/\s/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(filename);
        alert(' PDF scaricato: ' + filename);

    } catch (error) {
        console.error('Errore PDF:', error);
        alert(' Errore: ' + error.message);
    }
}

function normalizeEx(data) {
    if (!data) return [];
    if (Array.isArray(data)) return data.filter(e => e && e.name);
    return Object.values(data).filter(e => e && e.name);
}
