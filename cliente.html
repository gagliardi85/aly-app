<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area Cliente - Alissa Casagrande</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f8;
            color: #1a1a2e;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* LOGIN */
        .login-screen-bg {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(150deg, #fff 0%, #fff5fb 40%, #ffe0f0 70%, #fff 100%);
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .login-blob {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            animation: blobFloat 8s ease-in-out infinite;
        }

        .login-blob-1 { width: 380px; height: 380px; top: -120px; right: -100px; background: radial-gradient(circle, rgba(255,20,147,0.15) 0%, transparent 70%); }
        .login-blob-2 { width: 280px; height: 280px; bottom: -80px; left: -60px; background: radial-gradient(circle, rgba(255,100,180,0.12) 0%, transparent 70%); animation-delay: -3s; }
        .login-blob-3 { width: 180px; height: 180px; top: 45%; left: -40px; background: radial-gradient(circle, rgba(255,20,147,0.08) 0%, transparent 70%); animation-delay: -5s; }

        @keyframes blobFloat { 0%, 100% { transform: translateY(0px) scale(1); } 50% { transform: translateY(-20px) scale(1.05); } }

        .login-card-new {
            background: #fff;
            border-radius: 36px;
            padding: 48px 40px;
            max-width: 440px;
            width: 100%;
            box-shadow: 0 30px 80px rgba(255,20,147,0.18), 0 8px 24px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .login-logo-wrap { position: relative; margin-bottom: 28px; }
        .login-logo-ring { width: 118px; height: 118px; border-radius: 50%; background: linear-gradient(135deg, #FF1493, #ff6ec7, #FF1493); padding: 4px; box-shadow: 0 0 0 8px rgba(255,20,147,0.1), 0 12px 40px rgba(255,20,147,0.4); animation: logoGlow 3s ease-in-out infinite; }
        @keyframes logoGlow { 0%, 100% { box-shadow: 0 0 0 8px rgba(255,20,147,0.1), 0 12px 40px rgba(255,20,147,0.4); } 50% { box-shadow: 0 0 0 14px rgba(255,20,147,0.15), 0 16px 50px rgba(255,20,147,0.5); } }
        .login-logo-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #fff; display: block; }
        .login-logo-badge { position: absolute; bottom: 4px; right: 4px; width: 32px; height: 32px; background: linear-gradient(135deg, #FF1493, #ff5db3); border-radius: 50%; border: 3px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 4px 12px rgba(255,20,147,0.4); }

        .login-pill { display: inline-block; background: linear-gradient(135deg, #fff0f8, #ffe0f0); border: 1.5px solid #ffb3d9; border-radius: 30px; padding: 7px 20px; font-size: 11px; font-weight: 800; color: #FF1493; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; }
        .login-brand-name { font-size: 32px; font-weight: 900; color: #FF1493; text-align: center; margin: 0 0 6px; letter-spacing: -0.5px; line-height: 1.05; background: linear-gradient(135deg, #FF1493, #c2006e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .login-brand-sub { font-size: 14px; color: #aaa; font-weight: 500; text-align: center; margin: 0; }
        .login-divider-line { width: 56px; height: 4px; background: linear-gradient(90deg, #FF1493, #ff9dd5); border-radius: 3px; margin: 18px auto 24px; }
        .login-error-box { background: #fff0f8; color: #FF1493; border: 1.5px solid #ffb3d9; border-radius: 16px; padding: 12px 18px; font-size: 13px; font-weight: 600; text-align: center; width: 100%; margin-bottom: 16px; box-sizing: border-box; }

        .login-input-wrap { position: relative; width: 100%; margin-bottom: 16px; }
        .login-input-wrap.focused .login-input { border-color: #FF1493; box-shadow: 0 0 0 5px rgba(255,20,147,0.12); background: #fff; }
        .login-input-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); font-size: 20px; pointer-events: none; z-index: 1; }
        .login-input { width: 100%; padding: 20px 20px 20px 54px; border: 2px solid #ffe0f0; border-radius: 20px; font-size: 16px; background: #fff9fd; outline: none; transition: all 0.3s; color: #1a1a2e; font-weight: 500; box-sizing: border-box; }
        .login-input::placeholder { color: #cca8c0; }

        .login-btn-main { width: 100%; padding: 22px; background: linear-gradient(135deg, #FF1493 0%, #ff5db3 100%); color: white; border: none; border-radius: 20px; font-size: 17px; font-weight: 800; cursor: pointer; letter-spacing: 0.8px; box-shadow: 0 10px 32px rgba(255,20,147,0.5); transition: all 0.25s; display: flex; align-items: center; justify-content: center; gap: 12px; }
        .login-btn-main:hover { transform: translateY(-3px); box-shadow: 0 16px 44px rgba(255,20,147,0.6); }

        .login-stats-row { display: flex; align-items: center; justify-content: center; gap: 0; margin-top: 30px; padding-top: 24px; border-top: 1px solid #f5f5f5; width: 100%; }
        .login-stat { display: flex; flex-direction: column; align-items: center; gap: 4px; flex: 1; }
        .login-stat-icon { font-size: 22px; line-height: 1; }
        .login-stat-label { font-size: 10px; color: #bbb; font-weight: 700; letter-spacing: 0.5px; }
        .login-stat-sep { width: 1px; height: 36px; background: #f0f0f0; }

        /* HEADER */
        .header { background: #fff; color: #1a1a2e; padding: 12px 24px; box-shadow: 0 2px 0 #FF1493; position: sticky; top: 0; z-index: 1000; display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid #FF1493; }
        
        .header-logo { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 3px solid #FF1493; box-shadow: 0 2px 8px rgba(255,20,147,0.3); margin-right: 16px; }
        
        .header-content { display: flex; align-items: center; gap: 20px; flex: 1; }
        .header-title h1 { margin: 0; font-size: 18px; font-weight: 800; letter-spacing: 0.5px; line-height: 1.2; color: #FF1493; }
        .header-title p { margin: 3px 0 0 0; font-size: 11px; color: #888; font-weight: 500; }
        .header-actions { display: flex; gap: 10px; }
        .btn-logout { background: #fff0f0; color: #dc2626; border: 1.5px solid #dc2626; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-logout:hover { background: #dc2626; color: white; }

        /* WELCOME */
        .welcome-section { background: linear-gradient(135deg, #FF1493 0%, #ff6ec7 100%); color: white; padding: 28px 24px; border-radius: 20px; margin-bottom: 24px; text-align: center; box-shadow: 0 6px 24px rgba(255,20,147,0.3); }
        .welcome-title { font-size: 26px; font-weight: 800; margin-bottom: 6px; }
        .welcome-subtitle { font-size: 14px; opacity: 0.92; font-weight: 500; }

        /* CARDS */
        .card { background: #fff; border-radius: 20px; padding: 30px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); border: 1px solid #f0f0f0; width: 100%; max-width: 100%; box-sizing: border-box; overflow-x: hidden; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f5f5f5; }
        .card-title { font-size: 20px; color: #1a1a2e; font-weight: 700; }
        .badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-fucsia { background: #fff0f8; color: #FF1493; border: 1px solid #ffb3d9; }
        .badge-info { background: #eff6ff; color: #3b82f6; }

        /* PHASES */
        .phase-block { background: #fff5fb; border-radius: 16px; padding: 24px; margin-bottom: 20px; border-left: 5px solid #FF1493; }
        .phase-title { font-size: 16px; font-weight: 800; color: #FF1493; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .exercise-item { background: #fff; border-radius: 14px; padding: 18px; margin-bottom: 14px; border: 2px solid #f0f0f0; transition: all 0.3s; }
        .exercise-item:hover { border-color: #FF1493; box-shadow: 0 4px 12px rgba(255,20,147,0.1); }
        .exercise-name { font-weight: 800; color: #1a1a2e; font-size: 16px; margin-bottom: 8px; }
        .exercise-details { font-size: 13px; color: #888; display: flex; gap: 12px; flex-wrap: wrap; }
        .exercise-details span { background: linear-gradient(135deg, #fff0f8, #ffe0f0); color: #FF1493; padding: 4px 10px; border-radius: 8px; font-weight: 700; font-size: 12px; }

        /* BUTTONS */
        .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-fucsia { background: #FF1493 !important; color: white !important; box-shadow: 0 4px 14px rgba(255,20,147,0.3); }
        .btn-fucsia:hover { background: #e0006e !important; transform: translateY(-2px); }
        .btn-large { padding: 16px 28px; font-size: 16px; }
        .btn-success { background: #10b981 !important; color: white !important; }
        .btn-info { background: #0ea5e9 !important; color: white !important; }

        .buttons-container { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px; }
        .buttons-container .btn { flex: 1; min-width: 200px; text-align: center; justify-content: center; }

        /* TIMER */
        .current-exercise-card { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 3px solid #FF1493; border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(255,20,147,0.2); text-align: center; animation: slideIn 0.5s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .exercise-phase-badge { display: inline-block; background: linear-gradient(135deg, #FF1493, #ff6ec7); color: white; padding: 10px 24px; border-radius: 25px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(255,20,147,0.3); }

        .current-exercise-visual { margin: 25px 0; min-height: 220px; display: flex; align-items: center; justify-content: center; }
        .exercise-placeholder { width: 220px; height: 220px; background: linear-gradient(135deg, rgba(255,20,147,0.08), rgba(255,140,0,0.08)); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px dashed #FF1493; overflow: hidden; position: relative; flex-shrink: 0; font-size: 64px; line-height: 1; }
        .exercise-placeholder img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }

        .current-exercise-name { font-size: 24px; font-weight: 800; color: #1B3B6F; margin: 15px 0; line-height: 1.3; }
        .current-exercise-details { display: flex; gap: 12px; justify-content: center; margin: 15px 0; font-size: 15px; flex-wrap: wrap; }
        .current-exercise-details span { background: #f8fafc; padding: 8px 14px; border-radius: 8px; border-left: 3px solid #00CED1; font-weight: 600; color: #64748b; }
        .exercise-progress-info { margin-top: 15px; font-size: 13px; color: #94a3b8; font-weight: 600; }

        .timer-display { background: linear-gradient(135deg, #1B3B6F 0%, #FF1493 100%); color: white; padding: 40px 20px; border-radius: 20px; text-align: center; margin: 30px auto; font-size: 64px; font-weight: 800; font-family: 'Courier New', monospace; box-shadow: 0 12px 36px rgba(255,20,147,0.35); max-width: 600px; letter-spacing: 4px; }

        .timer-controls { display: flex; gap: 12px; justify-content: center; margin-top: 20px; flex-wrap: wrap; max-width: 600px; margin-left: auto; margin-right: auto; }
        .btn-timer { padding: 14px 24px; font-size: 14px; font-weight: 700; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s; flex: 1; min-width: 140px; }
        .btn-next-exercise { background: linear-gradient(135deg, #10b981, #059669); color: white; box-shadow: 0 6px 20px rgba(16,185,129,0.3); }
        .btn-next-exercise:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(16,185,129,0.4); }
        .btn-next-exercise:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-pause { background: #f59e0b; color: white; }
        .btn-pause:hover { background: #d97706; transform: translateY(-2px); }
        .btn-restart { background: #6366f1; color: white; }
        .btn-restart:hover { background: #4f46e5; transform: translateY(-2px); }
        .btn-stop { background: #ef4444; color: white; }
        .btn-stop:hover { background: #dc2626; transform: translateY(-2px); }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 24px; padding: 32px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f5f5f5; }
        .modal-title { font-size: 20px; font-weight: 800; color: #FF1493; margin: 0; }
        .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #94a3b8; }
        .modal-close:hover { color: #ef4444; }
        .modal-actions { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 24px; }

        /* FORM */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 14px; outline: none; transition: all 0.3s; box-sizing: border-box; }
        .form-control:focus { border-color: #FF1493; box-shadow: 0 0 0 3px rgba(255,20,147,0.1); }
        textarea.form-control { resize: vertical; min-height: 80px; }

        /* POPUP */
        .motivational-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.65); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .motivational-popup.active { display: flex; }
        .motivational-content { background: linear-gradient(135deg, #FF1493 0%, #ff6ec7 100%); color: white; padding: 56px 40px; border-radius: 28px; text-align: center; max-width: 480px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); animation: bounceIn 0.5s ease-out; }
        @keyframes bounceIn { 0% { opacity: 0; transform: scale(0.3); } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        .motivational-icon { font-size: 72px; margin-bottom: 16px; animation: rotate 2s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .motivational-text { font-size: 28px; font-weight: 800; margin: 0; }
        .motivational-subtext { font-size: 16px; opacity: 0.9; margin-top: 10px; }

        /* FOOTER */
        .backup-footer { background: white; border-top: 3px solid #f0f0f0; padding: 24px; margin-top: 0; box-shadow: 0 -4px 12px rgba(0,0,0,0.08); }
        .backup-footer h3 { font-size: 16px; color: #1B3B6F; margin-bottom: 15px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .backup-actions { display: flex; gap: 12px; flex-wrap: wrap; }

        /* INFO BOX */
        .info-box { background: rgba(0,206,209,0.1); border-left: 4px solid #00CED1; padding: 20px; border-radius: 10px; margin-top: 20px; font-size: 14px; color: #0c4a6e; }

        /* RESPONSIVE */
        @media (max-width: 600px) {
            .current-exercise-card { padding: 20px; }
            .current-exercise-name { font-size: 20px; }
            .timer-display { font-size: 48px; padding: 30px 15px; }
            .timer-controls { flex-direction: column; }
            .btn-timer { min-width: unset; width: 100%; }
            .modal-content { padding: 20px; max-height: 85vh; }
            .card { padding: 20px; }
            .buttons-container { flex-direction: column; }
            .buttons-container .btn { min-width: unset; width: 100%; }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-screen-bg" style="display: flex;">
        <div class="login-blob login-blob-1"></div>
        <div class="login-blob login-blob-2"></div>
        <div class="login-blob login-blob-3"></div>

        <div class="login-card-new">
            <div class="login-logo-wrap">
                <div class="login-logo-ring">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8DwHwAFBQIAX8jx0gAAAABJRU5ErkJggg==" alt="Logo" class="login-logo-img" id="clientLoginLogo">
                </div>
                <div class="login-logo-badge"></div>
            </div>

            <div class="login-pill">Personal Trainer & Mental Coach</div>
            <h1 class="login-brand-name">ALISSA<br>CASAGRANDE</h1>
            <p class="login-brand-sub">Body & Mind Revolution</p>
            <div class="login-divider-line"></div>

            <div id="loginError" class="login-error-box" style="display:none;"></div>

            <form id="loginForm" onsubmit="loginClient(event)" style="width:100%;margin-top:10px;">
                <div class="login-input-wrap">
                    <span class="login-input-icon"></span>
                    <input
                        type="text"
                        id="clientFullName"
                        class="login-input"
                        placeholder="Nome e Cognome"
                        required
                        autocomplete="off"
                        onfocus="this.parentElement.classList.add('focused')"
                        onblur="this.parentElement.classList.remove('focused')"
                    >
                </div>
                <button type="submit" class="login-btn-main">
                    <span></span>
                    <span>ACCEDI</span>
                </button>
            </form>

            <div class="login-stats-row">
                <div class="login-stat">
                    <span class="login-stat-icon"></span>
                    <span class="login-stat-label">SICURO</span>
                </div>
                <div class="login-stat-sep"></div>
                <div class="login-stat">
                    <span class="login-stat-icon"></span>
                    <span class="login-stat-label">VELOCE</span>
                </div>
                <div class="login-stat-sep"></div>
                <div class="login-stat">
                    <span class="login-stat-icon"></span>
                    <span class="login-stat-label">ESCLUSIVO</span>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" style="display: none;">
        <header class="header">
            <div class="header-content">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8DwHwAFBQIAX8jx0gAAAABJRU5ErkJggg==" alt="Logo" class="header-logo" id="clientHeaderLogo">
                <div class="header-title">
                    <h1>ALISSA CASAGRANDE</h1>
                    <p>Personal Trainer - Mental Coach</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-logout" onclick="logoutClient()"> Esci</button>
            </div>
        </header>

        <div style="max-width: 1200px; margin: 0 auto; padding: 30px 20px; width: 100%; box-sizing: border-box; overflow-x: hidden;">
            
            <div class="welcome-section">
                <div class="welcome-title">Ciao, <span id="clientNameDisplay">Cliente</span>! </div>
                <div class="welcome-subtitle">Sei pronta per la tua Rivoluzione Body & Mind?</div>
            </div>

            <div id="mainContent"></div>
        </div>

        <div class="backup-footer">
            <h3> Gestione Dati</h3>
            <div class="backup-actions">
                <button class="btn btn-fucsia" onclick="importWorkout()"> Importa Scheda</button>
                <button class="btn btn-success" onclick="exportClientData()"> Esporta Dati</button>
            </div>
        </div>
    </div>

    <!-- MODAL FEEDBACK -->
    <div class="modal" id="feedbackModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title"> Feedback Allenamento</h2>
                <button type="button" class="modal-close" onclick="closeModal('feedbackModal')">&times;</button>
            </div>

            <form id="feedbackForm">
                <div class="form-group">
                    <label class="form-label">Come ti sei sentita?</label>
                    <select class="form-control" name="feeling" required>
                        <option value="">Seleziona...</option>
                        <option value="ottimo"> Ottimo</option>
                        <option value="bene"> Bene</option>
                        <option value="faticoso"> Molto faticoso</option>
                        <option value="troppo_facile"> Troppo facile</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Parte difficile?</label>
                    <input type="text" class="form-control" name="difficult_part" placeholder="Es: Plank...">
                </div>

                <div class="form-group">
                    <label class="form-label">Durata:</label>
                    <select class="form-control" name="duration_adjustment">
                        <option value="perfetta"> Perfetta</option>
                        <option value="troppo_lunga"> Troppo lunga</option>
                        <option value="troppo_corta"> Troppo corta</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Intensit√†:</label>
                    <select class="form-control" name="intensity_adjustment">
                        <option value="giusta"> Giusta</option>
                        <option value="troppo_difficile"> Troppo difficile</option>
                        <option value="troppo_facile"> Troppo facile</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Dolore?</label>
                    <input type="text" class="form-control" name="pain_discomfort" placeholder="Descrivi...">
                </div>

                <div class="form-group">
                    <label class="form-label">Esercizi preferiti?</label>
                    <input type="text" class="form-control" name="favorite_exercises" placeholder="Es: Ponte glutei...">
                </div>

                <div class="form-group">
                    <label class="form-label">Note:</label>
                    <textarea class="form-control" name="notes" placeholder="Altro..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn btn-fucsia btn-large"> INVIA</button>
                    <button type="button" class="btn" onclick="closeModal('feedbackModal')">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- POPUP MOTIVAZIONALE -->
    <div id="motivationalPopup" class="motivational-popup">
        <div class="motivational-content">
            <div class="motivational-icon"></div>
            <div class="motivational-text">INIZIAMO!</div>
            <div class="motivational-subtext">La tua Rivoluzione Body & Mind comincia ORA!</div>
        </div>
    </div>

    <!-- FILE INPUTS -->
    <input type="file" id="workoutFileInput" accept=".json" style="display: none;" onchange="handleWorkoutImport(event)">
    <input type="file" id="dataFileInput" accept=".json" style="display: none;" onchange="handleDataImport(event)">

    <!-- SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <script src="js/database.js"></script>
    <script src="js/backup-manager.js"></script>

    <script>
        let CLIENT_ID = null;
        let CLIENT_NAME = null;
        let timerInterval = null;
        let timerSeconds = 0;
        let timerRunning = false;
        let currentSession = null;
        let currentWorkoutPlan = null;
        let allExercises = [];
        let currentExerciseIndex = 0;
        let logoBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAExAAIAAAAQAAABK2HiAQAAAwAAAAAA";

        window.addEventListener('DOMContentLoaded', async function() {
            loadLogo();

            let attempts = 0;
            while (!db || !db._ready) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
                if (attempts > 50) break;
            }

            const savedClientId = sessionStorage.getItem('client_id');
            const savedClientName = sessionStorage.getItem('client_name');
            
            if (savedClientId && savedClientName) {
                CLIENT_ID = savedClientId;
                CLIENT_NAME = savedClientName;
                showMainApp();
                setupRealtimeListener();
            }
        });

        function loadLogo() {
            const clientLoginLogo = document.getElementById('clientLoginLogo');
            const clientHeaderLogo = document.getElementById('clientHeaderLogo');
            
            if (clientLoginLogo) clientLoginLogo.src = logoBase64;
            if (clientHeaderLogo) clientHeaderLogo.src = logoBase64;
        }

        function setupRealtimeListener() {
            if (!db || !CLIENT_ID) return;
            
            document.addEventListener('db_updated', () => {
                loadClientData();
            });
        }

        async function loginClient(event) {
            event.preventDefault();
            
            const fullName = document.getElementById('clientFullName').value.trim();
            const errorEl = document.getElementById('loginError');

            if (!fullName) {
                errorEl.textContent = 'Inserisci nome e cognome';
                errorEl.style.display = 'block';
                return;
            }

            let attempts = 0;
            while (!db || !db._ready) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
                if (attempts > 50) break;
            }

            if (!db || !db._ready) {
                errorEl.textContent = 'Database non disponibile';
                errorEl.style.display = 'block';
                return;
            }

            const client = db.authenticateClient(fullName);
            
            if (client) {
                CLIENT_ID = client.id;
                CLIENT_NAME = client.name;
                sessionStorage.setItem('client_id', CLIENT_ID);
                sessionStorage.setItem('client_name', CLIENT_NAME);
                showMainApp();
                setupRealtimeListener();
            } else {
                errorEl.textContent = 'Nome non trovato';
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 3000);
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('clientNameDisplay').textContent = CLIENT_NAME;
            loadClientData();
        }

        function loadClientData() {
            const activePlan = db.getActivePlanByClientId(CLIENT_ID);
            const sessions = db.getSessionsByClientId(CLIENT_ID);

            let html = '';
            
            if (activePlan) {
                html += renderActiveWorkout(activePlan);
            } else {
                html += renderNoWorkout();
            }

            if (sessions.length > 0) {
                html += renderHistory(sessions);
            }

            html += '<div class="info-box"> Dopo ogni allenamento compila il feedback!</div>';

            document.getElementById('mainContent').innerHTML = html;
        }

        function renderActiveWorkout(plan) {
            return `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">La Tua Scheda</h2>
                    </div>

                    <div style="text-align: center; margin-bottom: 30px;">
                        <h3 style="color: #1B3B6F; font-size: 22px; margin-bottom: 15px;">${plan.title}</h3>
                        <span class="badge badge-fucsia"> ${plan.duration} min</span>
                        <span class="badge badge-info"> ${plan.objective}</span>
                    </div>

                    ${renderPhases(plan)}

                    <div class="buttons-container">
                        <button class="btn btn-fucsia btn-large" onclick="startWorkout('${plan.id}')">
                             INIZIA LA TUA RIVOLUZIONE
                        </button>
                        <button class="btn btn-info btn-large" onclick="downloadSchedaPDF()">
                             SCARICA SCHEDA PDF
                        </button>
                    </div>

                    <div id="timerSection" style="display: none;">
                        ${renderTimer()}
                    </div>
                </div>
            `;
        }

        function renderPhases(plan) {
            let html = '';
            
            const phases = [
                { title: ' Riscaldamento', ex: normalizeEx(plan.phases.warmup) },
                { title: ' Mobilit√†', ex: normalizeEx(plan.phases.mobility) },
                { title: ' Rinforzo', ex: normalizeEx((plan.phases.strength?.exercises) || plan.phases.strength) },
                { title: ' Circuito', ex: normalizeEx((plan.phases.circuit?.exercises) || plan.phases.circuit) },
                { title: ' Defaticamento', ex: normalizeEx(plan.phases.cooldown) }
            ];

            phases.forEach(phase => {
                if (phase.ex.length > 0) {
                    html += `
                        <div class="phase-block">
                            <div class="phase-title">${phase.title}</div>
                            ${phase.ex.map((e, i) => `
                                <div class="exercise-item">
                                    <div class="exercise-name">${i+1}. ${e.name || 'Esercizio'}</div>
                                    <div class="exercise-details">
                                        ${e.reps ? `<span> ${e.reps}</span>` : ''}
                                        ${e.duration ? `<span> ${e.duration}</span>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            });

            return html;
        }

        function normalizeEx(data) {
            if (!data) return [];
            if (Array.isArray(data)) return data.filter(e => e && e.name);
            return Object.values(data).filter(e => e && e.name);
        }

        function renderTimer() {
            return `
                <div class="current-exercise-card">
                    <div class="exercise-phase-badge" id="exercisePhaseBadge"> RISCALDAMENTO</div>
                    <div class="current-exercise-visual">
                        <div class="exercise-placeholder" id="exerciseCircle">
                            <img id="activeGifImg" src="" alt="GIF" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:50%;">
                            <span id="exerciseEmoji"></span>
                        </div>
                    </div>
                    <h3 class="current-exercise-name" id="currentExerciseName">Preparati!</h3>
                    <div class="current-exercise-details">
                        <span id="exerciseReps"></span>
                        <span id="exerciseDuration"></span>
                    </div>
                    <div class="exercise-progress-info" id="exerciseProgressText">Esercizio 1 di 1</div>
                </div>

                <div class="timer-display" id="timerDisplay">00:00</div>
                
                <div class="timer-controls">
                    <button class="btn-timer btn-next-exercise" onclick="nextExercise()" id="btnNextExercise"> Prossimo</button>
                    <button class="btn-timer btn-pause" onclick="pauseTimer()"> Pausa</button>
                    <button class="btn-timer btn-restart" onclick="restartWorkout()"> Ricomincia</button>
                    <button class="btn-timer btn-stop" onclick="stopWorkout()"> Completa</button>
                </div>
            `;
        }

        function startWorkout(planId) {
            currentWorkoutPlan = db.getActivePlanByClientId(CLIENT_ID);
            if (!currentWorkoutPlan) {
                alert('Errore: scheda non trovata');
                return;
            }

            allExercises = [];
            const phases = [
                { badge: ' RISCALDAMENTO', ex: normalizeEx(currentWorkoutPlan.phases.warmup) },
                { badge: ' MOBILIT√Ä', ex: normalizeEx(currentWorkoutPlan.phases.mobility) },
                { badge: ' RINFORZO', ex: normalizeEx((currentWorkoutPlan.phases.strength?.exercises) || currentWorkoutPlan.phases.strength) },
                { badge: ' CIRCUITO', ex: normalizeEx((currentWorkoutPlan.phases.circuit?.exercises) || currentWorkoutPlan.phases.circuit) },
                { badge: ' DEFATICAMENTO', ex: normalizeEx(currentWorkoutPlan.phases.cooldown) }
            ];

            phases.forEach(phase => {
                phase.ex.forEach(e => {
                    if (e && e.name) {
                        allExercises.push({ ...e, badge: phase.badge });
                    }
                });
            });

            if (allExercises.length === 0) {
                alert('Nessun esercizio trovato');
                return;
            }

            currentExerciseIndex = 0;
            document.getElementById('motivationalPopup').classList.add('active');
            
            setTimeout(() => {
                document.getElementById('motivationalPopup').classList.remove('active');
                
                currentSession = {
                    plan_id: planId,
                    client_id: CLIENT_ID,
                    started_at: Date.now()
                };

                document.getElementById('timerSection').style.display = 'block';
                timerRunning = true;
                timerSeconds = 0;
                updateTimerDisplay();
                updateExerciseDisplay();
                
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                }, 1000);

                document.getElementById('timerSection').scrollIntoView({ behavior: 'smooth' });
                
            }, 2500);
        }

        function updateTimerDisplay() {
            const mins = Math.floor(timerSeconds / 60);
            const secs = timerSeconds % 60;
            const display = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            
            const timerEl = document.getElementById('timerDisplay');
            if (timerEl) timerEl.textContent = display;
        }

        function updateExerciseDisplay() {
            if (!allExercises || allExercises.length === 0) return;

            const exercise = allExercises[currentExerciseIndex];
            if (!exercise) return;

            const phaseBadge = document.getElementById('exercisePhaseBadge');
            const nameEl = document.getElementById('currentExerciseName');
            const repsEl = document.getElementById('exerciseReps');
            const durationEl = document.getElementById('exerciseDuration');
            const progressEl = document.getElementById('exerciseProgressText');
            const btnNext = document.getElementById('btnNextExercise');
            const gifImg = document.getElementById('activeGifImg');
            const emojiEl = document.getElementById('exerciseEmoji');

            if (phaseBadge) phaseBadge.textContent = exercise.badge;
            if (nameEl) nameEl.textContent = exercise.name;
            if (repsEl) repsEl.textContent = exercise.reps ? ` ${exercise.reps}` : '';
            if (durationEl) durationEl.textContent = exercise.duration ? ` ${exercise.duration}` : '';
            if (progressEl) progressEl.textContent = `Esercizio ${currentExerciseIndex + 1} di ${allExercises.length}`;
            
            if (gifImg && emojiEl) {
                try {
                    const gifs = JSON.parse(localStorage.getItem('ptflow_exercise_gifs') || '{}');
                    const gifKey = exercise.name.toLowerCase().trim();
                    const gifUrl = gifs[gifKey]?.image;
                    
                    if (gifUrl) {
                        gifImg.src = gifUrl;
                        gifImg.style.display = 'block';
                        emojiEl.style.display = 'none';
                    } else {
                        gifImg.style.display = 'none';
                        emojiEl.style.display = 'block';
                    }
                } catch (e) {
                    console.warn('Errore GIF:', e);
                }
            }
            
            if (btnNext) {
                if (currentExerciseIndex >= allExercises.length - 1) {
                    btnNext.disabled = true;
                    btnNext.textContent = ' Ultimo';
                } else {
                    btnNext.disabled = false;
                    btnNext.textContent = ' Prossimo';
                }
            }
        }

        function nextExercise() {
            if (currentExerciseIndex < allExercises.length - 1) {
                currentExerciseIndex++;
                updateExerciseDisplay();
            }
        }

        function pauseTimer() {
            if (timerRunning) {
                clearInterval(timerInterval);
                timerRunning = false;
            } else {
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                }, 1000);
                timerRunning = true;
            }
        }

        function restartWorkout() {
            if (!confirm('Ricominciare da capo?')) return;
            clearInterval(timerInterval);
            timerSeconds = 0;
            currentExerciseIndex = 0;
            timerRunning = true;
            updateTimerDisplay();
            updateExerciseDisplay();
            
            timerInterval = setInterval(() => {
                timerSeconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function stopWorkout() {
            if (!currentSession) return;

            clearInterval(timerInterval);
            timerRunning = false;

            currentSession.duration_actual = timerSeconds;
            db.addSession(currentSession);

            document.getElementById('feedbackModal').classList.add('active');
            timerSeconds = 0;
            currentSession = null;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('feedbackForm');
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(e.target);
                    const feedback = {
                        client_id: CLIENT_ID,
                        feeling: formData.get('feeling'),
                        difficult_part: formData.get('difficult_part'),
                        duration_adjustment: formData.get('duration_adjustment'),
                        intensity_adjustment: formData.get('intensity_adjustment'),
                        pain_discomfort: formData.get('pain_discomfort'),
                        favorite_exercises: formData.get('favorite_exercises'),
                        notes: formData.get('notes')
                    };

                    db.addFeedback(feedback);
                    closeModal('feedbackModal');
                    e.target.reset();
                    document.getElementById('timerSection').style.display = 'none';
                    loadClientData();
                });
            }
        });

        function renderNoWorkout() {
            return `
                <div class="card" style="text-align: center; padding: 48px 24px;">
                    <div style="font-size: 64px; margin-bottom: 20px;"></div>
                    <h2 style="color: #1B3B6F;">Nessuna Scheda Attiva</h2>
                    <p style="color: #6b7280; margin: 15px 0 30px;">Alissa sta preparando il tuo programma!</p>
                    <button class="btn btn-fucsia btn-large" onclick="importWorkout()"> IMPORTA SCHEDA</button>
                </div>
            `;
        }

        function renderHistory(sessions) {
            if (sessions.length === 0) return '';
            return `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"> Storico</h2>
                        <span class="badge badge-fucsia">${sessions.length} completati</span>
                    </div>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        ${sessions.slice(-5).reverse().map(s => `
                            <li style="padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between;">
                                <div>
                                    <strong> ${new Date(s.completed_at).toLocaleDateString('it-IT')}</strong>
                                    <div style="font-size: 13px; color: #888;"> ${Math.floor(s.duration_actual / 60)} min</div>
                                </div>
                                <span style="font-size: 20px;"></span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        async function downloadSchedaPDF() {
            const plan = db.getActivePlanByClientId(CLIENT_ID);
            if (!plan) {
                alert('Nessuna scheda disponibile');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                
                let y = 15;
                const margin = 20;
                const pageW = doc.internal.pageSize.width;
                const contentW = pageW - (margin * 2);
                const pageH = doc.internal.pageSize.height;

                // ===== HEADER CON LOGO =====
                const logoSize = 25;
                const logoX = margin;
                const logoY = 8;
                
                doc.setFillColor(255, 20, 147);
                doc.circle(logoX + logoSize/2, logoY + logoSize/2, logoSize/2, 'F');
                doc.setFontSize(12);
                doc.setTextColor(255, 255, 255);
                doc.text('AC', logoX + logoSize/2, logoY + logoSize/2 + 1, { align: 'center', baseline: 'middle' });

                doc.setTextColor(255, 20, 147);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('ALISSA CASAGRANDE', logoX + logoSize + 8, logoY + 6);
                
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text('Personal Trainer & Mental Coach - Body & Mind Revolution', logoX + logoSize + 8, logoY + 12);

                doc.setDrawColor(255, 20, 147);
                doc.setLineWidth(1);
                doc.line(margin, logoY + logoSize + 3, pageW - margin, logoY + logoSize + 3);

                y = logoY + logoSize + 12;

                // ===== TITOLO SCHEDA =====
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 20, 147);
                doc.text(plan.title || 'Scheda di Allenamento', pageW / 2, y, { align: 'center' });
                y += 10;

                // ===== INFO SCHEDA =====
                doc.setFillColor(255, 240, 248);
                doc.rect(margin, y - 3, contentW, 10, 'F');
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 20, 147);
                doc.text(`Durata: ${plan.duration} min  |  Obiettivo: ${plan.objective}`, margin + 3, y + 2);
                y += 14;

                // ===== SEZIONI ESERCIZI =====
                const phases = [
                    { title: 'üî• RISCALDAMENTO', color: [255, 100, 100], ex: normalizeEx(plan.phases.warmup) },
                    { title: 'üßò MOBILIT√Ä', color: [100, 150, 255], ex: normalizeEx(plan.phases.mobility) },
                    { title: 'üí™ RINFORZO', color: [255, 20, 147], ex: normalizeEx((plan.phases.strength?.exercises) || plan.phases.strength) },
                    { title: '‚ö° CIRCUITO', color: [255, 165, 0], ex: normalizeEx((plan.phases.circuit?.exercises) || plan.phases.circuit) },
                    { title: '‚ú® DEFATICAMENTO', color: [100, 200, 100], ex: normalizeEx(plan.phases.cooldown) }
                ];

                phases.forEach(phase => {
                    if (phase.ex.length > 0) {
                        if (y > pageH - 50) {
                            doc.addPage();
                            y = 20;
                        }

                        doc.setFillColor(...phase.color);
                        doc.rect(margin, y - 4, contentW, 8, 'F');
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(255, 255, 255);
                        doc.text(phase.title, margin + 3, y);
                        y += 12;

                        phase.ex.forEach((ex, idx) => {
                            if (y > pageH - 20) {
                                doc.addPage();
                                y = 20;
                            }

                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(40, 40, 40);
                            doc.text(`${idx + 1}. ${ex.name}`, margin + 3, y);
                            y += 5;

                            if (ex.reps || ex.duration) {
                                doc.setFontSize(9);
                                doc.setFont('helvetica', 'normal');
                                doc.setTextColor(100, 100, 100);
                                
                                let details = [];
                                if (ex.reps) details.push(`Ripetizioni: ${ex.reps}`);
                                if (ex.duration) details.push(`Durata: ${ex.duration}`);
                                
                                doc.text(details.join('  |  '), margin + 5, y);
                            }

                            y += 6;
                            
                            doc.setDrawColor(230, 230, 230);
                            doc.setLineWidth(0.3);
                            doc.line(margin + 3, y, pageW - margin - 3, y);
                            y += 3;
                        });

                        y += 6;
                    }
                });

                // ===== FOOTER =====
                const footerY = pageH - 10;
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.setFont('helvetica', 'italic');
                doc.text('Body & Mind Revolution - Alissa Casagrande', pageW / 2, footerY, { align: 'center' });
                doc.text(`Generato: ${new Date().toLocaleDateString('it-IT')}`, pageW / 2, footerY + 4, { align: 'center' });

                const filename = `Scheda_${CLIENT_NAME.replace(/\s/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                alert(' PDF scaricato: ' + filename);

            } catch (error) {
                console.error('Errore PDF:', error);
                alert(' Errore: ' + error.message);
            }
        }

        function importWorkout() {
            document.getElementById('workoutFileInput').click();
        }

        async function handleWorkoutImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (!data.plan) throw new Error('File non valido');

                const plan = {
                    ...data.plan,
                    client_id: CLIENT_ID,
                    status: 'attiva',
                    imported_at: new Date().toISOString()
                };

                const existingPlans = db.getPlansByClientId(CLIENT_ID);
                for (const p of existingPlans) {
                    if (p.status === 'attiva') {
                        await db.updatePlan(p.id, { status: 'completata' });
                    }
                }

                await db.addPlan(plan);
                alert(' Scheda importata!');
                loadClientData();
                
            } catch (error) {
                alert(' Errore: ' + error.message);
            }

            event.target.value = '';
        }

        async function exportClientData() {
            if (backupManager) {
                backupManager.exportClientData(CLIENT_ID);
            } else {
                alert('Backup manager non disponibile');
            }
        }

        function logoutClient() {
            if (confirm('Uscire?')) {
                sessionStorage.removeItem('client_id');
                sessionStorage.removeItem('client_name');
                location.reload();
            }
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.classList.remove('active');
        }
    </script>
</body>
</html>
